<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple Secure AI Voice Game</title>
    <style>
        :root {
            --primary-color: #4361ee;
            --secondary-color: #3f37c9;
            --success-color: #4cc9f0;
            --warning-color: #f72585;
            --danger-color: #e63946;
            --light-color: #f8f9fa;
            --dark-color: #212529;
            --game-mode-bg: linear-gradient(135deg, #4361ee, #3a0ca3);
            --moderator-mode-bg: linear-gradient(135deg, #f72585, #b5179e);
            --end-mode-bg: linear-gradient(135deg, #2ec4b6, #1a936f);
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #1d2b64, #f8cdda);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            width: 100%;
            max-width: 1200px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: var(--shadow);
            overflow: hidden;
            backdrop-filter: blur(10px);
        }

        header {
            background: var(--primary-color);
            color: white;
            padding: 20px;
            text-align: center;
            position: relative;
        }

        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .subtitle {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .mode-indicator {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.2);
            padding: 10px 15px;
            border-radius: 30px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .setup-screen, .game-screen {
            padding: 30px;
        }

        .setup-screen {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: var(--shadow);
            margin-bottom: 20px;
        }

        .card-title {
            font-size: 1.5rem;
            margin-bottom: 20px;
            color: var(--secondary-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .input-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark-color);
        }

        input, select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1rem;
            transition: var(--transition);
        }

        input:focus, select:focus {
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.2);
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background: var(--secondary-color);
            transform: translateY(-2px);
        }

        .btn-block {
            width: 100%;
            padding: 15px;
            font-size: 1.1rem;
        }

        .game-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .timer-display {
            font-size: 1.5rem;
            font-weight: bold;
            background: var(--light-color);
            padding: 10px 20px;
            border-radius: 10px;
            box-shadow: var(--shadow);
        }

        .player-display {
            font-size: 1.3rem;
            font-weight: bold;
            color: var(--primary-color);
        }

        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .mic-button {
            background: var(--success-color);
            color: white;
            border: none;
            width: 70px;
            height: 70px;
            border-radius: 50%;
            font-size: 1.5rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: var(--shadow);
            transition: var(--transition);
        }

        .mic-button.recording {
            background: var(--danger-color);
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .mic-button:disabled {
            background: #cccccc;
            cursor: not-allowed;
            transform: none;
            animation: none;
        }

        .history-container {
            background: var(--light-color);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            max-height: 300px;
            overflow-y: auto;
        }

        .history-title {
            font-size: 1.3rem;
            margin-bottom: 15px;
            color: var(--secondary-color);
        }

        .history-item {
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 10px;
            background: white;
            box-shadow: var(--shadow);
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .history-player {
            font-weight: bold;
            color: var(--primary-color);
            margin-bottom: 5px;
        }

        .history-content {
            margin-bottom: 10px;
            line-height: 1.5;
        }

        .history-timestamp {
            font-size: 0.8rem;
            color: #666;
            text-align: right;
        }

        .ai-response {
            background: var(--light-color);
            border-radius: 15px;
            padding: 25px;
            min-height: 150px;
        }

        .ai-title {
            font-size: 1.3rem;
            margin-bottom: 15px;
            color: var(--secondary-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .ai-content {
            line-height: 1.6;
            font-size: 1.1rem;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(67, 97, 238, 0.3);
            border-radius: 50%;
            border-top-color: var(--primary-color);
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .status-bar {
            height: 10px;
            background: var(--game-mode-bg);
            transition: var(--transition);
            margin-bottom: 30px;
            border-radius: 5px;
        }

        .status-bar.moderator-mode {
            background: var(--moderator-mode-bg);
        }

        .status-bar.end-mode {
            background: var(--end-mode-bg);
        }

        .hidden {
            display: none;
        }

        .alert {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .alert-warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }

        .alert-info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }

        .game-mode-indicator {
            background: var(--game-mode-bg);
            color: white;
        }

        .moderator-mode-indicator {
            background: var(--moderator-mode-bg);
            color: white;
        }

        .end-mode-indicator {
            background: var(--end-mode-bg);
            color: white;
        }

        @media (max-width: 768px) {
            .container {
                border-radius: 10px;
            }
            
            h1 {
                font-size: 2rem;
            }
            
            .setup-screen, .game-screen {
                padding: 20px;
            }
            
            .game-header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .controls {
                justify-content: center;
            }
        }

        .visualization {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100px;
            margin: 20px 0;
        }

        .visualizer-bar {
            width: 5px;
            height: 20px;
            background: var(--primary-color);
            margin: 0 2px;
            border-radius: 2px;
            animation: visualizer 1s infinite alternate paused;
        }

        .recording .visualizer-bar {
            animation-play-state: running;
        }

        @keyframes visualizer {
            from { height: 20px; }
            to { height: 60px; }
        }

        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .stat-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            box-shadow: var(--shadow);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary-color);
            margin: 10px 0;
        }

        .stat-label {
            color: #666;
            font-size: 0.9rem;
        }

        .player-stats {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: var(--shadow);
        }

        .player-stats h3 {
            margin-bottom: 15px;
            color: var(--secondary-color);
        }

        .player-stats div {
            margin: 10px 0;
            padding: 10px;
            background: var(--light-color);
            border-radius: 10px;
        }

        footer {
            text-align: center;
            padding: 20px;
            color: #666;
            font-size: 0.9rem;
            border-top: 1px solid #eee;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üîí Simple Secure AI Voice Game</h1>
            <p class="subtitle">5 minutes game mode + 5 minutes moderation mode</p>
            <div class="mode-indicator game-mode-indicator" id="modeIndicator">
                <span>üéÆ Setup Mode</span>
            </div>
        </header>

        <div class="status-bar" id="statusBar"></div>

        <!-- Setup Screen -->
        <div class="setup-screen" id="setupScreen">
            <div class="card">
                <h2 class="card-title">üë• Player Setup</h2>
                <div class="input-group">
                    <label for="player1Name">Player 1 Name:</label>
                    <input type="text" id="player1Name" placeholder="Enter Player 1 name">
                </div>
                <div class="input-group">
                    <label for="player2Name">Player 2 Name:</label>
                    <input type="text" id="player2Name" placeholder="Enter Player 2 name">
                </div>
            </div>

            <div class="card">
                <h2 class="card-title">üé≤ Game Selection</h2>
                <div class="input-group">
                    <label for="gameSelect">Choose a Story Theme:</label>
                    <select id="gameSelect">
                        <option value="fantasy">Fantasy Adventure</option>
                        <option value="sci-fi">Sci-Fi Odyssey</option>
                        <option value="mystery">Mystery Detective</option>
                        <option value="superhero">Superhero Chronicles</option>
                        <option value="pirate">Pirate Treasure Hunt</option>
                    </select>
                </div>
            </div>

            <button class="btn btn-primary btn-block" id="startGameBtn">
                üöÄ Start Game Session
            </button>
        </div>

        <!-- Game Screen -->
        <div class="game-screen hidden" id="gameScreen">
            <div class="game-header">
                <div class="timer-display" id="timer">‚è±Ô∏è 05:00</div>
                <div class="player-display" id="currentPlayer">Waiting to start...</div>
            </div>

            <div class="visualization" id="visualization">
                <div class="visualizer-bar"></div>
                <div class="visualizer-bar"></div>
                <div class="visualizer-bar"></div>
                <div class="visualizer-bar"></div>
                <div class="visualizer-bar"></div>
                <div class="visualizer-bar"></div>
                <div class="visualizer-bar"></div>
                <div class="visualizer-bar"></div>
                <div class="visualizer-bar"></div>
                <div class="visualizer-bar"></div>
            </div>

            <div class="stats-container">
                <div class="stat-card">
                    <div class="stat-label">Total Turns</div>
                    <div class="stat-value" id="turnCount">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Words Spoken</div>
                    <div class="stat-value" id="wordCount">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Avg. Creativity</div>
                    <div class="stat-value" id="avgCreativity">‚≠ê‚≠ê‚≠ê</div>
                </div>
            </div>
            
            <div class="player-stats">
                <h3>Player Statistics</h3>
                <div id="player1Stats">Player 1 stats will appear here</div>
                <div id="player2Stats">Player 2 stats will appear here</div>
            </div>

            <div class="controls">
                <button class="mic-button" id="micButton" disabled>
                    üé§
                </button>
                <button class="btn btn-primary" id="skipTurnBtn" disabled>
                    ‚è≠Ô∏è Skip Turn
                </button>
                <button class="btn" id="newGameBtn">
                    üîÑ New Game
                </button>
            </div>

            <div class="history-container">
                <h3 class="history-title">üìú Conversation History</h3>
                <div id="history">
                    <p style="text-align: center; color: #999;">No messages yet...</p>
                </div>
            </div>

            <div class="ai-response">
                <h3 class="ai-title">ü§ñ AI Feedback</h3>
                <div class="ai-content" id="aiResponse">
                    Game not started yet. Press the microphone button to begin!
                </div>
            </div>
        </div>

        <footer>
            <p>Simple Secure AI Voice Game &copy; 2025 | Powered by Secure Backend</p>
        </footer>
    </div>

    <script>
        // Game state
        let backendUrl = '';
        let player1Name = '';
        let player2Name = '';
        let currentPlayer = 1;
        let gameMode = 'setup'; // setup, game, moderator, end
        let timeLeft = 300; // 5 minutes in seconds
        let timerInterval = null;
        let gameHistory = [];
        let recognition = null;
        let isRecording = false;
        let sessionId = null;
        
        // Game statistics
        let turnCount = 0;
        let totalWordCount = 0;
        let creativityScores = [];
        let playerStats = {
            1: { turns: 0, words: 0, avgCreativity: 0, violations: 0 },
            2: { turns: 0, words: 0, avgCreativity: 0, violations: 0 }
        };

        // Available games
        const games = {
            'fantasy': {
                name: 'Fantasy Adventure',
                rules: 'Create an epic fantasy tale with magic, mythical creatures, and heroic quests. Each player builds on the previous contribution.'
            },
            'sci-fi': {
                name: 'Sci-Fi Odyssey',
                rules: 'Build a futuristic space adventure with advanced technology, alien civilizations, and interstellar travel. Continue the story logically.'
            },
            'mystery': {
                name: 'Mystery Detective',
                rules: 'Construct a thrilling detective story with clues, suspects and plot twists. Each turn should add to solving the mystery.'
            },
            'superhero': {
                name: 'Superhero Chronicles',
                rules: 'Develop a superhero saga with powers, villains, and epic battles. Build action-packed scenes with dramatic tension.'
            },
            'pirate': {
                name: 'Pirate Treasure Hunt',
                rules: 'Create a swashbuckling pirate adventure on the high seas with treasure maps, sea battles, and island discoveries.'
            }
        };

        // Initialize the app
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM fully loaded and parsed');
            
            // Set backend URL to current host
            // For Render deployment, we need to ensure we're using the correct URL
            if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                backendUrl = window.location.origin;
            } else {
                // For production deployments, use the same origin
                backendUrl = window.location.origin;
            }
            
            console.log('Backend URL set to:', backendUrl);
            
            initializeSpeechRecognition();
            setupEventListeners();
            
            console.log('App initialization complete');
        });
        
        // Also set up a fallback in case DOMContentLoaded doesn't fire
        if (document.readyState === 'loading') {
            console.log('Document still loading, waiting for DOMContentLoaded');
        } else {
            console.log('Document already loaded, initializing app');
            // Document is already loaded
            setTimeout(function() {
                if (typeof backendUrl === 'undefined') {
                    backendUrl = window.location.origin;
                    console.log('Fallback: Backend URL set to:', backendUrl);
                    initializeSpeechRecognition();
                    setupEventListeners();
                }
            }, 100);
        }

        function initializeSpeechRecognition() {
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();
                recognition.continuous = false;
                recognition.interimResults = false;
                recognition.lang = 'en-US';

                recognition.onresult = function(event) {
                    const transcript = event.results[0][0].transcript;
                    handleTranscript(transcript);
                };

                recognition.onerror = function(event) {
                    console.error('Speech recognition error', event.error);
                    stopRecording();
                    updateAIResponse(`‚ùå Speech recognition error: ${event.error}`);
                };

                recognition.onend = function() {
                    stopRecording();
                };
            } else {
                alert('Speech recognition not supported in this browser. Please try Chrome or Edge.');
            }
        }

        function setupEventListeners() {
            console.log('Setting up event listeners');
            const startBtn = document.getElementById('startGameBtn');
            const micBtn = document.getElementById('micButton');
            const skipBtn = document.getElementById('skipTurnBtn');
            const newGameBtn = document.getElementById('newGameBtn');
            
            console.log('Elements found:', {
                startBtn: !!startBtn,
                micBtn: !!micBtn,
                skipBtn: !!skipBtn,
                newGameBtn: !!newGameBtn
            });
            
            if (startBtn) {
                startBtn.addEventListener('click', function(e) {
                    console.log('START BUTTON CLICKED');
                    console.log('Event:', e);
                    console.log('Current target:', e.currentTarget);
                    startGame();
                });
                console.log('Start button event listener added');
            } else {
                console.error('Start button not found!');
            }
            
            if (micBtn) {
                micBtn.addEventListener('click', function(e) {
                    console.log('MIC BUTTON CLICKED');
                    toggleRecording();
                });
                console.log('Mic button event listener added');
            }
            
            if (skipBtn) {
                skipBtn.addEventListener('click', function(e) {
                    console.log('SKIP BUTTON CLICKED');
                    skipTurn();
                });
                console.log('Skip button event listener added');
            }
            
            if (newGameBtn) {
                newGameBtn.addEventListener('click', function(e) {
                    console.log('NEW GAME BUTTON CLICKED');
                    resetGame();
                });
                console.log('New game button event listener added');
            }
            
            console.log('All event listeners set up');
        }

        async function startGame() {
            console.log('=== START GAME FUNCTION CALLED ===');
            console.log('Current DOM state:');
            console.log('- Player 1 input value:', document.getElementById('player1Name').value);
            console.log('- Player 2 input value:', document.getElementById('player2Name').value);
            console.log('- Game select value:', document.getElementById('gameSelect').value);
            
            player1Name = document.getElementById('player1Name').value.trim();
            player2Name = document.getElementById('player2Name').value.trim();
            selectedGame = document.getElementById('gameSelect').value;

            console.log('Trimmed values:');
            console.log('- Player 1:', player1Name);
            console.log('- Player 2:', player2Name);
            console.log('- Game type:', selectedGame);

            if (!player1Name || !player2Name) {
                console.log('ERROR: Missing player names');
                alert('Please enter names for both players.');
                return;
            }

            console.log('All validation passed, proceeding to create session');
            console.log('Backend URL:', backendUrl);

            // Show loading state
            const startBtn = document.getElementById('startGameBtn');
            const originalText = startBtn.innerHTML;
            startBtn.innerHTML = '<div class="loading"></div> Starting Game...';
            startBtn.disabled = true;

            // Create game session on backend
            try {
                console.log('Making POST request to:', `${backendUrl}/api/game/session`);
                console.log('Request payload:', {
                    player1Name,
                    player2Name,
                    gameType: selectedGame
                });
                
                const response = await fetch(`${backendUrl}/api/game/session`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        player1Name,
                        player2Name,
                        gameType: selectedGame
                    })
                });

                console.log('Response received:');
                console.log('- Status:', response.status);
                console.log('- Status text:', response.statusText);
                
                // Log response headers
                console.log('- Response headers:');
                for (let [key, value] of response.headers.entries()) {
                    console.log(`  ${key}: ${value}`);
                }

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('FAILED: Server returned error status');
                    console.error('- Error text:', errorText);
                    throw new Error(`Failed to create game session: ${response.status} - ${errorText}`);
                }

                const data = await response.json();
                console.log('SUCCESS: Session created');
                console.log('- Data received:', data);
                sessionId = data.sessionId;
                
                // Switch to game screen
                console.log('Switching to game screen');
                document.getElementById('setupScreen').classList.add('hidden');
                document.getElementById('gameScreen').classList.remove('hidden');
                
                // Initialize game state
                gameMode = 'game';
                timeLeft = 300; // 5 minutes
                currentPlayer = 1;
                gameHistory = [];
                turnCount = 0;
                totalWordCount = 0;
                creativityScores = [];
                playerStats = {
                    1: { turns: 0, words: 0, avgCreativity: 0, violations: 0 },
                    2: { turns: 0, words: 0, avgCreativity: 0, violations: 0 }
                };
                
                // Update UI
                updateModeIndicator();
                startTimer();
                updatePlayerDisplay();
                document.getElementById('aiResponse').innerHTML = 'üéôÔ∏è Game started! Player 1, press the microphone button and begin your story...';
                
                // Enable controls
                document.getElementById('micButton').disabled = false;
                document.getElementById('skipTurnBtn').disabled = false;
                
                console.log('Game started successfully!');
                
            } catch (error) {
                console.error('=== CATCH BLOCK REACHED ===');
                console.error('Full error object:', error);
                console.error('Error name:', error.name);
                console.error('Error message:', error.message);
                console.error('Error stack:', error.stack);
                
                alert(`Failed to start game: ${error.message}`);
            } finally {
                // Restore button state
                startBtn.innerHTML = originalText;
                startBtn.disabled = false;
                console.log('Button state restored');
            }
        }

        function updateModeIndicator() {
            const modeIndicator = document.getElementById('modeIndicator');
            const statusBar = document.getElementById('statusBar');
            
            modeIndicator.classList.remove('game-mode-indicator', 'moderator-mode-indicator', 'end-mode-indicator');
            statusBar.classList.remove('game-mode', 'moderator-mode', 'end-mode');
            
            switch(gameMode) {
                case 'game':
                    modeIndicator.innerHTML = 'üéÆ Game Mode';
                    modeIndicator.classList.add('game-mode-indicator');
                    statusBar.classList.add('game-mode');
                    break;
                case 'moderator':
                    modeIndicator.innerHTML = 'üõ°Ô∏è Moderator Mode';
                    modeIndicator.classList.add('moderator-mode-indicator');
                    statusBar.classList.add('moderator-mode');
                    break;
                case 'end':
                    modeIndicator.innerHTML = 'üéâ Game Complete!';
                    modeIndicator.classList.add('end-mode-indicator');
                    statusBar.classList.add('end-mode');
                    break;
                default:
                    modeIndicator.innerHTML = 'üéÆ Setup Mode';
                    modeIndicator.classList.add('game-mode-indicator');
            }
        }

        function startTimer() {
            clearInterval(timerInterval);
            updateTimerDisplay();
            
            timerInterval = setInterval(() => {
                timeLeft--;
                updateTimerDisplay();
                
                if (timeLeft <= 0) {
                    if (gameMode === 'game') {
                        switchToModeratorMode();
                    } else if (gameMode === 'moderator') {
                        endGame();
                    }
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;
            document.getElementById('timer').textContent = `‚è±Ô∏è ${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        function updatePlayerDisplay() {
            const playerName = currentPlayer === 1 ? player1Name : player2Name;
            document.getElementById('currentPlayer').textContent = `üé§ ${playerName}'s Turn`;
        }

        function toggleRecording() {
            // Check if current player is banned
            if (playerStats[currentPlayer] && playerStats[currentPlayer].violations >= 3) {
                document.getElementById('aiResponse').innerHTML = `üö´ Player ${currentPlayer === 1 ? player1Name : player2Name} is banned and cannot speak.`;
                return;
            }
            
            if (isRecording) {
                stopRecording();
            } else {
                startRecording();
            }
        }

        function startRecording() {
            if (!recognition) {
                document.getElementById('aiResponse').innerHTML = '‚ùå Speech recognition not available. Please use Chrome or Edge browser.';
                return;
            }
            
            isRecording = true;
            const micButton = document.getElementById('micButton');
            micButton.textContent = '‚èπÔ∏è';
            micButton.classList.add('recording');
            
            // Enable visualization animation
            document.getElementById('visualization').classList.add('recording');
            
            try {
                recognition.start();
                document.getElementById('aiResponse').innerHTML = '<div class="loading"></div> Listening... Speak now!';
                console.log('Speech recognition started successfully');
            } catch (error) {
                console.error('Error starting speech recognition:', error);
                stopRecording();
                document.getElementById('aiResponse').innerHTML = `‚ùå Error starting speech recognition: ${error.message}. Please check microphone permissions.`;
            }
        }

        function stopRecording() {
            if (!recognition) return;
            
            isRecording = false;
            const micButton = document.getElementById('micButton');
            micButton.textContent = 'üé§';
            micButton.classList.remove('recording');
            
            // Disable visualization animation
            document.getElementById('visualization').classList.remove('recording');
            
            try {
                recognition.stop();
            } catch (error) {
                console.error('Error stopping speech recognition:', error);
            }
        }

        async function handleTranscript(transcript) {
            if (!transcript.trim()) return;
            
            // Add to game history
            const entry = {
                player: currentPlayer,
                playerName: currentPlayer === 1 ? player1Name : player2Name,
                content: transcript,
                timestamp: new Date()
            };
            
            gameHistory.push(entry);
            updateHistoryDisplay();
            
            // Update statistics
            turnCount++;
            const wordCount = transcript.split(' ').length;
            totalWordCount += wordCount;
            
            // Update player stats
            playerStats[currentPlayer].turns++;
            playerStats[currentPlayer].words += wordCount;
            
            updateStats();
            
            // Send to backend for AI evaluation
            try {
                document.getElementById('aiResponse').innerHTML = '<div class="loading"></div> Evaluating...';
                
                const response = await fetch(`${backendUrl}/api/game/${sessionId}/turn`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        player: currentPlayer,
                        content: transcript
                    })
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Failed to evaluate turn: ${response.status} - ${errorText}`);
                }
                
                const data = await response.json();
                document.getElementById('aiResponse').innerHTML = data.aiResponse;
                
                // Update player stats from backend
                if (data.playerStats) {
                    playerStats = data.playerStats;
                    updateStats();
                }
                
                // Check if player is banned
                if (data.isBanned) {
                    document.getElementById('aiResponse').innerHTML = `üö´ PLAYER ${currentPlayer === 1 ? player1Name : player2Name} HAS BEEN BANNED FROM THE GAME FOR INAPPROPRIATE CONTENT!`;
                    
                    // Check if both players are banned
                    if (data.bannedPlayers && data.bannedPlayers.length >= 2) {
                        setTimeout(() => {
                            endGame();
                            document.getElementById('aiResponse').innerHTML = 'üö´ GAME TERMINATED: Both players have been banned for inappropriate content.';
                        }, 3000);
                    } else {
                        // Switch to other player
                        setTimeout(() => {
                            currentPlayer = currentPlayer === 1 ? 2 : 1;
                            updatePlayerDisplay();
                            document.getElementById('aiResponse').innerHTML = `${currentPlayer === 1 ? player1Name : player2Name}'s turn. Please continue the story.`;
                        }, 3000);
                    }
                    return;
                }
                
            } catch (error) {
                console.error('Backend API Error:', error);
                document.getElementById('aiResponse').innerHTML = `‚ùå Error: ${error.message}. Please check your connection.`;
            }
            
            // Switch player
            currentPlayer = currentPlayer === 1 ? 2 : 1;
            updatePlayerDisplay();
        }

        function updateHistoryDisplay() {
            const historyContainer = document.getElementById('history');
            
            if (gameHistory.length === 0) {
                historyContainer.innerHTML = '<p style="text-align: center; color: #999;">No messages yet...</p>';
                return;
            }
            
            let historyHTML = '';
            gameHistory.forEach(entry => {
                const timeString = entry.timestamp.toLocaleTimeString();
                historyHTML += `
                    <div class="history-item">
                        <div class="history-player">${entry.playerName} (Player ${entry.player})</div>
                        <div class="history-content">${entry.content}</div>
                        <div class="history-timestamp">${timeString}</div>
                    </div>
                `;
            });
            
            historyContainer.innerHTML = historyHTML;
            historyContainer.scrollTop = historyContainer.scrollHeight;
        }

        function calculatePlayerAverage(turns, scores) {
            if (scores.length === 0) return 0;
            return scores.reduce((a, b) => a + b, 0) / scores.length;
        }

        function updateStats() {
            document.getElementById('turnCount').textContent = turnCount;
            document.getElementById('wordCount').textContent = totalWordCount;
            
            if (creativityScores.length > 0) {
                const avgScore = Math.round(creativityScores.reduce((a, b) => a + b, 0) / creativityScores.length);
                document.getElementById('avgCreativity').textContent = '‚≠ê'.repeat(avgScore);
            }
            
            // Update player-specific stats
            document.getElementById('player1Stats').innerHTML = `
                <strong>${player1Name}:</strong> ${playerStats[1].turns} turns, ${playerStats[1].words} words<br>
                Violations: ${playerStats[1].violations || 0}/3
            `;
            document.getElementById('player2Stats').innerHTML = `
                <strong>${player2Name}:</strong> ${playerStats[2].turns} turns, ${playerStats[2].words} words<br>
                Violations: ${playerStats[2].violations || 0}/3
            `;
        }

        async function switchToModeratorMode() {
            gameMode = 'moderator';
            timeLeft = 300; // 5 minutes for moderator mode
            startTimer();
            updateModeIndicator();
            
            document.getElementById('currentPlayer').textContent = 'üîç Analyzing Conversation';
            document.getElementById('micButton').disabled = true;
            document.getElementById('skipTurnBtn').disabled = true;
            
            document.getElementById('aiResponse').innerHTML = '<div class="loading"></div> Analyzing entire conversation for moderation...';
            
            try {
                const response = await fetch(`${backendUrl}/api/game/${sessionId}/moderate`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Failed to get moderation report: ${response.status} - ${errorText}`);
                }
                
                const data = await response.json();
                document.getElementById('aiResponse').innerHTML = data.aiResponse;
                
            } catch (error) {
                document.getElementById('aiResponse').innerHTML = `‚ùå Error analyzing conversation: ${error.message}`;
            }
        }

        function endGame() {
            gameMode = 'end';
            clearInterval(timerInterval);
            updateModeIndicator();
            document.getElementById('currentPlayer').textContent = 'Thanks for playing!';
            document.getElementById('micButton').disabled = true;
            document.getElementById('skipTurnBtn').disabled = true;
            
            updateAIResponse(`
                <h3>üéâ Game and Moderation Session Complete!</h3>
                <p>Review the conversation history above.</p>
                <p><strong>Final Statistics:</strong></p>
                <ul>
                    <li>Total Turns: ${turnCount}</li>
                    <li>Words Spoken: ${totalWordCount}</li>
                    <li>Average Creativity: ${creativityScores.length > 0 ? '‚≠ê'.repeat(Math.round(creativityScores.reduce((a, b) => a + b, 0) / creativityScores.length)) : 'N/A'}</li>
                </ul>
                <p>Click "New Game" to play again!</p>
            `);
        }

        function skipTurn() {
            currentPlayer = currentPlayer === 1 ? 2 : 1;
            updatePlayerDisplay();
            document.getElementById('aiResponse').innerHTML = `‚è≠Ô∏è ${currentPlayer === 1 ? player1Name : player2Name}'s turn was skipped. It's now ${currentPlayer === 1 ? player1Name : player2Name}'s turn.`;
        }

        function resetGame() {
            clearInterval(timerInterval);
            document.getElementById('setupScreen').classList.remove('hidden');
            document.getElementById('gameScreen').classList.add('hidden');
            document.getElementById('history').innerHTML = '<p style="text-align: center; color: #999;">No messages yet...</p>';
            
            // Reset form
            document.getElementById('player1Name').value = '';
            document.getElementById('player2Name').value = '';
            
            // Reset mode indicator
            gameMode = 'setup';
            updateModeIndicator();
        }
    </script>
</body>
</html>